jQuery&&function(t){function s(t,i,s,a,e){if(a){if(a.isDefaultPrevented())return;if(void 0!==a.button&&0!==a.button)return;a.preventDefault()}var n,h=Math.round(e.position.x-s.touch.x),d=Math.round(e.position.y-s.touch.y);if("ratio"===this.images[t].format){var r=1;("bl"===i||"tr"===i)&&(r=-1);var n=(d+h*r)/2;h=r*Math.min(s.maxDelta.x,Math.max(s.minDelta.x,r*n)),d=Math.round(n/this.data[t].ratio),d=void 0!==s.maxDelta.y?Math.min(s.maxDelta.y,Math.max(s.minDelta.y,d)):Math.max(s.minDelta.y,d),d=Math.round(d*this.data[t].ratio),h!=d&&(n=Math.abs(h)<Math.abs(d)?h:d),d=Math.round(n/this.data[t].ratio),h=Math.round(n*r)}else h=Math.min(s.maxDelta.x,Math.max(s.minDelta.x,h)),d=void 0!==s.maxDelta.y?Math.min(s.maxDelta.y,Math.max(s.minDelta.y,d)):Math.max(s.minDelta.y,d);-1!==i.search(/l/)?(this.data[t].div.offset({left:s.offset.left+h}),this.data[t].div.width(s.width-h)):-1!==i.search(/r/)&&this.data[t].div.width(s.width+h),-1!==i.search(/t/)?(this.data[t].div.offset({top:s.offset.top+d}),this.data[t].div.height(s.height-d)):-1!==i.search(/b/)&&this.data[t].div.height(s.height+d),o.call(this,t,i),f.call(this)}function a(t,i,s,a,e){if(a){if(a.isDefaultPrevented())return;if(void 0!==a.button&&0!==a.button)return;a.preventDefault()}var n=Math.round(e.position.x-s.touch.x),h=Math.round(e.position.y-s.touch.y),d=this.divs.pad.offset(),r=Math.min(d.left+this.divs.pad.width()-this.data[t].div.width(),Math.max(d.left,s.offset.left+n)),l=Math.max(d.top,s.offset.top+h);this.data[t].div.offset({left:r,top:l}),o.call(this,t,i),f.call(this)}function e(){var t,i=-1,s=-1,a=0,e=0,n=[];for(t in this.images)l.call(this,t),n[t]=this.images[t],(-1===i||n[t].position[0]<i)&&(i=n[t].position[0]),(-1===s||n[t].position[1]<s)&&(s=n[t].position[1]),a=Math.max(a,n[t].position[0]+n[t].box[0]),e=Math.max(e,n[t].position[1]+n[t].box[1]);a=(a-i)/100,e=(e-s)/100;for(t in n)(i>0||s>0)&&(i>0&&(n[t].position[0]-=i),s>0&&(n[t].position[1]-=s)),n[t].position[0]=n[t].position[0]/a,n[t].position[1]=n[t].position[1]/a,n[t].box[0]=n[t].box[0]/a,n[t].box[1]=n[t].box[1]/a}function n(t){var i,s=this.divs.pad.width()-2;for(i in t)t[i].box&&(t[i].box[0]=t[i].box[0]/100*s,t[i].box[1]=t[i].box[1]/100*s),t[i].position&&(t[i].position[0]=t[i].position[0]/100*s,t[i].position[1]=t[i].position[1]/100*s)}function h(t,s,a,n){if(n){if(n.isDefaultPrevented())return;n.preventDefault()}if(o.call(this,t,s,!0),f.call(this,!0),l.call(this,t),e.call(this),null===s){if(this.events.finishMove)for(i in this.events.finishMove)this.events.finishMove[i](this.images)}else if(this.events.finishResize)for(i in this.events.finishResize)this.events.finishResize[i](this.images);if(this.events.finishAction)for(i in this.events.finishAction)this.events.finishAction[i](this.images)}function o(t,i,s){var a,e,n,h,o;s?(h="linked",o={t:{},l:{},b:{},r:{}}):h="toLink";var f={t:0,b:0,l:0,r:0},r={t:-1,b:-1,l:-1,r:-1},l=this.data[t].div.offset();(null===i||-1!==i.search(/l/))&&(r.l=l.left),(null===i||-1!==i.search(/r/))&&(r.r=l.left+this.data[t].div.width()),(null===i||-1!==i.search(/t/))&&(r.t=l.top),(null===i||-1!==i.search(/b/))&&(r.b=l.top+this.data[t].div.height());var v,m;for(a in this.images){if(s)for(n in r)this.data[a][n].removeClass("toLink");if(a!=t){m={l:r.l,r:r.r,t:r.t,b:r.b},l=this.data[a].div.offset(),v={l:l.left,r:l.left+this.data[a].div.width(),t:l.top,b:l.top+this.data[a].div.height()},-1!==m.t&&(v.t>=m.t-M&&v.t<=m.t+M?(v.t=-1,m.t=-1,f.t=1,s&&(o.t[a]="t",this.data[a].links.t[t]="t")):v.b>=m.t-M&&v.b<=m.t+M&&(v.b=-1,m.t=-1,f.t=1,s&&(o.t[a]="b",this.data[a].links.b[t]="t"))),-1!==m.b&&(-1!==v.t&&v.t>=m.b-M&&v.t<=m.b+M?(v.t=-1,m.b=-1,f.b=1,s&&(o.b[a]="t",this.data[a].links.t[t]="b")):-1!==v.b&&v.b>=m.b-M&&v.b<=m.b+M&&(v.b=-1,m.b=-1,f.b=1,s&&(o.b[a]="b",this.data[a].links.b[t]="b"))),-1!==m.l&&(v.l>=m.l-M&&v.l<=m.l+M?(v.l=-1,m.l=-1,f.l=1,s&&(o.l[a]="l",this.data[a].links.l[t]="l")):v.r>=m.l-M&&v.r<=m.l+M&&(v.r=-1,m.l=-1,f.l=1,s&&(o.l[a]="r",this.data[a].links.r[t]="l"))),-1!==m.r&&(-1!==v.l&&v.l>=m.r-M&&v.l<=m.r+M?(v.l=-1,m.r=-1,f.r=1,s&&(o.r[a]="l",this.data[a].links.l[t]="r")):-1!==v.r&&v.r>=m.r-M&&v.r<=m.r+M&&(v.r=-1,m.r=-1,f.r=1,s&&(o.r[a]="r",this.data[a].links.r[t]="r")));for(e in v)-1===v[e]?this.data[a][e].hasClass(h)||this.data[a][e].addClass(h):(this.data[a][e].hasClass(h)&&this.data[a][e].removeClass(h),s&&this.data[a].links[e][t]&&delete this.data[a].links[e][t])}}for(e in f)1===f[e]?this.data[t][e].hasClass(h)||this.data[t][e].addClass(h):this.data[t][e].hasClass(h)&&this.data[t][e].removeClass(h);if(s){d.call(this,t,i,o);for(a in r)-1!==r[a]&&(this.data[t].links[a]=o[a])}}function d(t,i,s){var a,e={dimension:[-1,-1],offset:{left:-1,top:-1}},n={dimension:[this.data[t].div.width(),this.data[t].div.height()],offset:this.data[t].div.offset()};if(s){if(s.t)for(a in s.t){e.offset.top="t"==s.t[a]?this.data[a].div.offset().top:this.data[a].div.offset().top+this.data[a].div.height()+M,i&&-1!==i.search(/t/)&&(e.dimension[1]=n.dimension[1]+(n.offset.top-e.offset.top));break}if(s.l)for(a in s.l){e.offset.left="l"==s.l[a]?this.data[a].div.offset().left:this.data[a].div.offset().left+this.data[a].div.width()+M,i&&-1!==i.search(/l/)&&(e.dimension[0]=n.dimension[0]+(n.offset.left-e.offset.left));break}if(s.r)for(a in s.r){if(-1!==e.offset.left||i&&-1!==i.search(/r/)){var h=-1!==e.offset.left?e.offset.left:n.offset.left;e.dimension[0]="l"==s.r[a]?this.data[a].div.offset().left-M-h:this.data[a].div.offset().left+this.data[a].div.width()-h}else{var o=-1!==e.dimension[0]?e.dimension[0]:n.dimension[0];e.offset.left="l"==s.r[a]?this.data[a].div.offset().left-M-o:this.data[a].div.offset().left+this.data[a].div.width()-o}break}if(s.b)for(a in s.b){if(-1!==e.offset.top||i&&-1!==i.search(/b/)){var h=-1!==e.offset.top?e.offset.top:n.offset.top;e.dimension[1]="t"==s.b[a]?this.data[a].div.offset().top-M-h:this.data[a].div.offset().top+this.data[a].div.height()-h}else{var o=-1!==e.dimension[1]?e.dimension[1]:n.dimension[1];e.offset.top="t"==s.b[a]?this.data[a].div.offset().top-M-o:this.data[a].div.offset().top+this.data[a].div.height()-o}break}if("ratio"===this.images[t].format){var o;if(-1!==e.dimension[1]){ratioDim=e.dimension[1]*this.data[t].ratio;var o=-1!==e.dimension[0]?e.dimension[0]:n.dimension[0];if(ratioDim!==o&&(e.dimension[0]=ratioDim,!s.l&&s.r||i&&-1!==i.search(/l/))){var h=-1!==e.offset.left?e.offset.left:n.offset.left;e.offset.left=h+(o-ratioDim)}}else if(-1!==e.dimension[0]){ratioDim=e.dimension[0]/this.data[t].ratio;var o=-1!==e.dimension[1]?e.dimension[1]:n.dimension[1];if(ratioDim!==o&&(e.dimension[1]=ratioDim,!s.t&&s.b||i&&-1!==i.search(/i/))){var h=-1!==e.offset.top?e.offset.top:n.offset.top;e.offset.top=h+(o-ratioDim)}}}-1!==e.dimension[0]&&this.data[t].div.width(e.dimension[0]),-1!==e.dimension[1]&&this.data[t].div.height(e.dimension[1]);var h={},d=!1;-1!==e.offset.top&&(h.top=e.offset.top,d=!0),-1!==e.offset.left&&(h.left=e.offset.left,d=!0),d&&this.data[t].div.offset(h)}}function f(t){var i,s=150;for(i in this.images){{this.data[i].div.height()+this.data[i].div.offset().top}s=Math.max(this.data[i].div.height()+this.data[i].div.position().top,s)}(t||s>this.divs.pad.height())&&this.divs.pad.height(s)}function r(t){switch(this.images[t].format){case"crop":if(this.data[t].div.css("background-position",(this.images[t].offset&&-1!==this.images[t].offset[0]?this.images[t].offset[0]+"px":"center")+" "+(this.images[t].offset&&-1!==this.images[t].offset[1]?this.images[t].offset[1]+"px":"center")),-1!==this.images[t].scale){this.data[t].div.css("background-size",this.images[t].size[0]*this.images[t].scale+"px "+this.images[t].size[1]*this.images[t].scale+"px");break}case"ratio":this.data[t].div.css("background-size","cover")}}function l(t){var i=this.images[t],s=this.data[t].div;offset=s.offset(),i.position=[Math.round(offset.left),Math.round(offset.top)],i.box=[Math.round(s.width()),Math.round(s.height())],"crop"===i.format||(i.scale&&delete i.scale,i.offset&&delete i.offset)}function v(){var s=this;if(this.options.actions)for(i in this.options.actions)this.options.actions[i]instanceof Object&&this.options.actions[i].label&&this.options.actions[i].func&&this.options.actions[i].func.call&&this.divs.settings.append(t("<button>"+this.options.actions[i].label+"</button>").bind("singletap",this.options.actions[i].func.bind(null,s)))}function m(t,i){if(console.log("toggleFormat called"),this.images[t]){if(i&&i.preventDefault){if(i.isDefaultPrevented())return;i.preventDefault()}if("crop"==this.images[t].format){this.images[t].format="ratio",this.data[t].div.removeClass("crop"),console.log(this.images[t]),console.log(this.data[t]);var s=Math.round(this.data[t].div.width()/this.data[t].ratio)-this.data[t].div.height(),a=Math.round(this.data[t].div.height()*this.data[t].ratio)-this.data[t].div.width();a&&(Math.abs(a)>Math.abs(s)?this.data[t].div.height(this.data[t].div.height()+s):this.data[t].div.width(this.data[t].div.width()+a)),l.call(this,t)}else this.images[t].format="crop",this.data[t].div.addClass("crop");r.call(this,t)}}function p(t,i){null!==this.currentImageId&&(this.currentHandle?s.call(this,this.currentImageId,this.currentHandle,this.initialEvent,t,i):a.call(this,this.currentImageId,this.currentHandle,this.initialEvent,t,i))}function c(t){null!==this.currentImageId&&(h.call(this,this.currentImageId,this.currentHandle,this.initialEvent,t),this.currentImageId=null,this.currentHandle=null,this.initialEvent=null)}function g(i,s){var a,e,n=t(i.target);if(i&&i.preventDefault){if(i.isDefaultPrevented())return;i.preventDefault()}do{if(void 0!==(a=n.data("arrangerImageId")))break;if(n.is(this.divs.pad))return}while(n=n.parent());this.currentImageId=a,this.initialEvent={ev:i,touch:s.position,width:this.data[a].div.width(),height:this.data[a].div.height(),offset:this.data[a].div.offset(),pos:this.data[a].div.position()},(e=n.data("arrangerHandle"))&&(this.currentHandle=e,this.initialEvent.minDelta={},this.initialEvent.maxDelta={},-1!==e.search(/l/)?(this.initialEvent.minDelta.x=-this.initialEvent.pos.left,this.initialEvent.maxDelta.x=this.initialEvent.width-this.options.minSize.width):(this.initialEvent.minDelta.x=this.options.minSize.width-this.initialEvent.width,this.initialEvent.maxDelta.x=this.divs.pad.width()-this.initialEvent.pos.left-this.initialEvent.width),-1!==e.search(/t/)?(this.initialEvent.minDelta.y=-this.initialEvent.pos.top,this.initialEvent.maxDelta.y=this.initialEvent.height-this.options.minSize.height):this.initialEvent.minDelta.y=this.options.minSize.height-this.initialEvent.height)}function u(i,s){var a,e;this.images=[],this.data=[],this.divs={},this.nextX=0,this.nextY=0,this.options=t.extend({actions:[],nextStep:30,addedImagePercentage:25,minSize:{width:60,height:60}},s),this.events={preMove:[],preResize:[],finishMove:[],finishResize:[],finishAction:[]},this.currentImageId=null,this.currentHandle=null;for(a in this.events)if(this.options[a])if(this.options[a].call)this.events[a].push(this.options[a]);else if(this.options[a]instanceof Array){for(e in this.options[a])this.options[a][e].call||this.options[a].splice(e,1);this.events[a].concat(this.options[a])}i.append(this.divs.settings=t('<div class="settings"></div>')),i.append(this.divs.pad=t('<div class="pad"></div>')),this.divs.div=i,v.call(this);var h;(h=this.divs.pad.closest("body")).length||(h=this.divs.pad),this.divs.pad.bind("tapstart",g.bind(this)),h.bind("tapmove",p.bind(this)),h.bind("tapend",c.bind(this)),this.options.images&&(this.options.percent&&n.call(this,this.options.images),this.addImage(this.options.images))}var b=["tl","tr","br","bl"],x=["t","r","b","l"],D="arranger",M=10;u.prototype={addImage:function(i){i instanceof Array||(i=[i]);var s;for(s in i)if(i[s]instanceof Object&&i[s].href){var a=this.images.length;if(this.images[a]=i[s],this.data[a]={links:{l:{},r:{},t:{},b:{}}},this.divs.pad.append(this.data[a].div=t("<div style=\"background: url('"+i[s].href+"');position: absolute; background-repeat: no-repeat;\"></div>").attr("data-arranger-image-id",a).data("arrangerImageId",a)),this.images[a].width&&this.images[a].height?this.images[a].size=[this.images[a].width,this.images[a].height]:this.images[a].box&&(this.images[a].size=this.images[a].box),this.data[a].ratio=this.images[a].size[0]/this.images[a].size[1],!this.images[a].box){var e=Math.min(this.divs.pad.width(),this.divs.pad.width()*this.options.addedImagePercentage/100);this.images[a].box=[e,e/this.data[a].ratio]}this.images[a].format||(this.images[a].format=this.images[a].scale||this.images[a].offset?"crop":"ratio"),this.images[a].position||(this.nextX+this.images[a].box[0]>this.divs.pad.width()&&(this.nextX=0),this.images[a].position=[this.nextX,this.nextY],this.nextX+=this.options.nextStep,this.nextY+=this.options.nextStep),"crop"==this.images[a].format&&(this.images[a].scale||(this.images[a].scale=-1),this.images[a].offset||(this.images[a].offset=[-1,-1])),this.data[a].div.width(i[s].box[0]),this.data[a].div.height(i[s].box[1]);var n=this.divs.pad.offset();this.data[a].div.offset({left:n.left+i[s].position[0],top:n.top+i[s].position[1]}),r.call(this,a);var h;for(h in x)this.data[a].div.append(this.data[a][x[h]]=t('<div class="'+x[h]+'"></div>'));for(h in b)this.data[a].div.append(this.data[a][b[h]]=t('<div class="'+b[h]+'"></div>').data("arrangerImageId",a).data("arrangerHandle",b[h]));this.data[a].div.append(this.data[a].settings=t('<div class="settings"></div>').append(this.data[a].crop=t('<div class="crop" title="Toggle between fixed ratio and fill/crop"></div>').bind("singletap",m.bind(this,a)).bind("tapstart",function(t){t.preventDefault()})))}f.call(this,!0)},updateImages:function(t,i){var s,a,e,n=this.images.length,h=[];for(s in t)if(e=!1,a=t[s],a instanceof Object&&a.href){if(a.id){for(j=0;j<this.images.length;j++)if(this.images[j].id&&a.id==this.images[j].id){e=j;break}}else for(j=0;j<this.images.length;j++)if(a.href==this.images[j].href){e=j;break}e!==!1?h.push(e):this.addImage(a)}if(i)for(s=n-1;s>=0;s--)-1===h.indexOf(s)&&(this.images.splice(s,1),this.data[s].div.remove(),this.data.splice(s,1))},deleteImage:function(t){var i,s,a,e;for(i in this.images)if(this.data[i].id&&this.data[i].id===t){for(s in this.data[i].links){e=this.data[i].links[s];for(a in e)delete this.data[a].links[e[a]][t]}return this.data[i].div.remove(),delete this.images[i],!0}return!1},getData:function(){return images},bind:function(t,i){return this.events[t]&&i&&i.call?(this.events[t].push(i),!0):!1},unbind:function(t,i){if(this.events[t]&&i&&i.call){var s;if(-1!==(s=this.events[t].indexOf(i)))return this.events[t].splice(s,1),!0}return!1}},t.extend(t.fn,{arranger:function(i){var s;if(i instanceof Object)t(this).each(function(){(s=t(this).data(D))&&t(this).data(D)instanceof u?i.images&&s.updateImages(i.images,!0):t(this).data(D,new u(t(this),i))});else if("string"==typeof i){if((s=t(this).data(D))&&s instanceof u&&s[i]){var a=Array.prototype.slice.call(arguments,1);s[i].apply(s,a)}}else if(void 0===i)return t(this).data(D);return t(this)}})}(jQuery);